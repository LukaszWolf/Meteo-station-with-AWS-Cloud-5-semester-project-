<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: hooks/useAuth.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: hooks/useAuth.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file useAuth.js
 * @description Custom hook to manage user authentication state using AWS
 * Amplify. It handles sign-in/sign-out events and ensures the necessary IoT
 * policies are attached to the user identity.
 */

import {Auth, Hub} from 'aws-amplify';
import {useEffect, useState} from 'react';

/** API Endpoint for attaching IoT Policy to Cognito Identity */
const ATTACH_API_URL =
    'https://wjngrfdjy3.execute-api.eu-north-1.amazonaws.com/attach';

/**
 * @function useAuth
 * @description Provides authentication state and methods.
 *
 * @returns {Object} Auth object containing:
 * - user {Object|null}: The current authenticated user object or null.
 * - signIn {Function}: Method to trigger federated sign-in.
 * - signOut {Function}: Method to sign out the current user.
 */
export function useAuth() {
  const [user, setUser] = useState(null);

  /**
   * Calls the backend API to attach the AWS IoT Policy to the current Cognito
   * Identity. This is required for the user to publish/subscribe to MQTT
   * topics.
   */
  const ensureIoTPolicyAttached = async () => {
    try {
      const creds = await Auth.currentCredentials();
      let headers = {'Content-Type': 'application/json'};
      try {
        const session = await Auth.currentSession();
        headers.Authorization = session.getIdToken().getJwtToken();
      } catch {
        // Token might not be available, proceed without it if necessary
      }

      await fetch(ATTACH_API_URL, {
        method: 'POST',
        headers,
        body: JSON.stringify({identityId: creds.identityId}),
      });
    } catch (e) {
      console.warn('Policy attach error:', e);
    }
  };

  /**
   * Checks for an authenticated user session and updates state.
   */
  const checkUser = async () => {
    try {
      const u = await Auth.currentAuthenticatedUser();
      setUser(u);
      await ensureIoTPolicyAttached();
    } catch {
      setUser(null);
    }
  };

  /**
   * Effect: Sets up an Amplify Hub listener to react to auth events (signIn,
   * signOut).
   */
  useEffect(() => {
    const unsub = Hub.listen('auth', ({payload: {event}}) => {
      if (event === 'signIn' || event === 'cognitoHostedUI')
        checkUser();
      else if (event === 'signOut')
        setUser(null);
    });
    checkUser();
    return unsub;
  }, []);

  const signIn = () => Auth.federatedSignIn();
  const signOut = () => Auth.signOut();

  return {user, signIn, signOut};
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#ATTACH_API_URL">ATTACH_API_URL</a></li><li><a href="global.html#AWS_IOT_ENDPOINT">AWS_IOT_ENDPOINT</a></li><li><a href="global.html#CLAIM_API_URL">CLAIM_API_URL</a></li><li><a href="global.html#FORECAST_URL">FORECAST_URL</a></li><li><a href="global.html#GEO_URL">GEO_URL</a></li><li><a href="global.html#formatDateDDMM">formatDateDDMM</a></li><li><a href="global.html#formatDateLabel">formatDateLabel</a></li><li><a href="global.html#formatTimeHHMM">formatTimeHHMM</a></li><li><a href="global.html#getTs">getTs</a></li><li><a href="global.html#getUvLevel">getUvLevel</a></li><li><a href="global.html#getWeatherIcon">getWeatherIcon</a></li><li><a href="global.html#mapJsonToDashboardData">mapJsonToDashboardData</a></li><li><a href="global.html#sortByTs">sortByTs</a></li><li><a href="global.html#useAuth">useAuth</a></li><li><a href="global.html#useStationClaim">useStationClaim</a></li><li><a href="global.html#useStationData">useStationData</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.5</a> on Sun Jan 18 2026 18:43:40 GMT+0100 (czas Å›rodkowoeuropejski standardowy)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
