<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: hooks/useStationData.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: hooks/useStationData.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file useStationData.js
 * @description Custom hook for fetching and managing station telemetry data
 * from AWS S3. It retrieves historical data files, parses them, and formats
 * them for the dashboard.
 */

import {Auth, Storage} from 'aws-amplify';
import {useEffect, useState} from 'react';

/**
 * Helper: Maps raw JSON data from S3 to the dashboard's expected format.
 * Performs unit conversions (e.g., dividing raw temp by 10).
 * @param {Object} json - Raw JSON object from the station.
 * @returns {Object} Normalized data object.
 */
const mapJsonToDashboardData = (json) => {
  return {
    outdoorTemp: json.outdoorTemperatureRead != null ?
        json.outdoorTemperatureRead / 10 :
        null,
    humidity: json.humidityRead ?? null,
    pressure: json.pressureRead ?? null,
    uvIndex: json.uvIndexRead != null ? json.uvIndexRead / 10 : null,
    indoorTemp:
        json.indoorTemperatureRead != null ? json.indoorTemperatureRead : null,
    lastUpdate: json.ts ?? null,
  };
};

/**
 * @function useStationData
 * @description Manages data fetching for the station dashboard.
 *
 * @param {Object} user - The authenticated user object.
 * @returns {Object} Data object containing:
 * - history {Array}: Chronologically sorted array of historical measurements.
 * - measurement {Object|null}: The single most recent measurement.
 * - loading {boolean}: Fetching status.
 * - reloadData {Function}: Function to manually trigger a data refresh.
 */
export function useStationData(user) {
  const [history, setHistory] = useState([]);
  const [measurement, setMeasurement] = useState(null);
  const [loading, setLoading] = useState(false);

  const loadFiles = async () => {
    if (!user) return;

    setLoading(true);
    try {
      const creds = await Auth.currentCredentials();
      const id = creds.identityId;

      // 1. List all files in the user's station folder
      const {results} =
          await Storage.list(`users/${id}/stations/`, {level: 'public'});

      // 2. Sort files by modification date (newest first)
      results.sort(
          (a, b) => new Date(b.lastModified) - new Date(a.lastModified));

      // 3. Limit to the 48 most recent files for performance
      const recentFiles = results.slice(0, 48);

      if (recentFiles.length > 0) {
        const historyData = [];

        // Parallel download of file contents
        await Promise.all(recentFiles.map(async (file) => {
          try {
            const result =
                await Storage.get(file.key, {download: true, level: 'public'});
            const text = await result.Body.text();
            const obj = JSON.parse(text);
            historyData.push(mapJsonToDashboardData(obj));
          } catch (err) {
            console.warn(`Error parsing file ${file.key}`, err);
          }
        }));

        // Sort history chronologically (oldest -> newest) for charts
        historyData.sort((a, b) => (a.lastUpdate || 0) - (b.lastUpdate || 0));
        setHistory(historyData);

        // Set the latest measurement
        if (historyData.length > 0) {
          setMeasurement(historyData[historyData.length - 1]);
        }
      }
    } catch (err) {
      console.error('Data fetch error:', err);
    } finally {
      setLoading(false);
    }
  };

  // Auto-load when user logs in
  useEffect(() => {
    if (user) {
      loadFiles();
    } else {
      setHistory([]);
      setMeasurement(null);
    }
  }, [user]);

  return {history, measurement, loading, reloadData: loadFiles};
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#ATTACH_API_URL">ATTACH_API_URL</a></li><li><a href="global.html#AWS_IOT_ENDPOINT">AWS_IOT_ENDPOINT</a></li><li><a href="global.html#CLAIM_API_URL">CLAIM_API_URL</a></li><li><a href="global.html#FORECAST_URL">FORECAST_URL</a></li><li><a href="global.html#GEO_URL">GEO_URL</a></li><li><a href="global.html#formatDateDDMM">formatDateDDMM</a></li><li><a href="global.html#formatDateLabel">formatDateLabel</a></li><li><a href="global.html#formatTimeHHMM">formatTimeHHMM</a></li><li><a href="global.html#getTs">getTs</a></li><li><a href="global.html#getUvLevel">getUvLevel</a></li><li><a href="global.html#getWeatherIcon">getWeatherIcon</a></li><li><a href="global.html#mapJsonToDashboardData">mapJsonToDashboardData</a></li><li><a href="global.html#sortByTs">sortByTs</a></li><li><a href="global.html#useAuth">useAuth</a></li><li><a href="global.html#useStationClaim">useStationClaim</a></li><li><a href="global.html#useStationData">useStationData</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.5</a> on Sun Jan 18 2026 18:43:40 GMT+0100 (czas Å›rodkowoeuropejski standardowy)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
